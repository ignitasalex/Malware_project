# EternalBlue Ransomware Project

This is a project, part of the Malware course of the Cybersecurity Master at UPC. For a comprehensive breakdown of each phase and the technical implementation, please refer to the accompanying PDF document at documents/Group_8-Final_Report.pdf

## Overview

The objective of this project is to compromise a small to medium-sized enterprise that operates several Windows-based systems. Initially, an email will be dispatched to an employee, informing them that their company has been chosen to test a new financial tool enhanced by machine learning and artificial intelligence. This purported tool is an Excel file embedded with a malicious macro.

Upon the employee downloading the file and enabling its content, the macro will initiate the download of additional files from our public server. Subsequently, it will conduct a scan of all machines within the same subnet as the initial target, specifically identifying those susceptible to the EternalBlue vulnerability. If vulnerable machines are detected, the macro will attempt to exploit them by deploying and executing the exploit script.


### Scenario

![Malware_project](documents/scenario.PNG)

On the left side, we observe the victim company's environment, which includes the computer designated to receive the email containing the malware, as well as other vulnerable machines within the same network. On the right side, we see the attacker's setup, comprising a Kali machine used for debugging purposes and a server responsible for the downloading and uploading of files.

### Phases of attack

This attack comprises five distinct phases (the last of which is optional) designed to infiltrate the victim's environment, perform basic reconnaissance to identify vulnerable elements, and subsequently exploit them. These phases are as follows:

- Phishing
- Environment Scanning
- EternalBlue Exploitation
- Ransomware Encryption
- Ransomware Decryption [Optional]

#### 1. Phishing

**Objective**: Gain entry into the victim's environment via a legitimate-looking entry vector.



**Method**:
- Send an email to a corporate employee, introducing a new machine learning and AI-based financial application.

![Malware_project](documents/email.PNG)

- Attach an Excel file with an embedded malicious macro and a text file with instructions to enable content editing.

![Malware_project](documents/excel.PNG)


**Trojan Horse**:
- The Excel file contains a macro written in Visual Basic.
- Upon enabling content, the macro executes automatically.
- It collects the logged-in username and system language, downloads files from our server, executes them, and removes traces to prevent reverse engineering.


#### 2. Environment Scanning

**Objective**: Identify vulnerable machines within the local network.

**Method**:
- The macro's scan script retrieves all network interfaces (excluding the loopback interface) and uses them to search for vulnerable computers.
- The script has two main sections:
  - **Initial Check**: Determines if the computer is online by checking if port 445 (SMB) is open.
  - **Vulnerability Check**: Uses SMB to send a transaction of type `TRANS_PEEK_NMPIPE` to leak information and check if the machine is vulnerable to EternalBlue.
    - The vulnerability is identified by the Windows NT status code `0xC0000205` (STATUS_INSUFF_SERVER_RESOURCES), indicating insufficient server resources.


#### 3. EternalBlue Exploitation

**Objective**: Exploit the EternalBlue vulnerability to gain control over target devices.

**Method**:
- **Vulnerability Overview**: EternalBlue targets a series of errors in the SMB protocol, notably exploited in the WannaCry ransomware attack.
  - **Error 1**: A mathematical miscalculation occurs when converting OS/2 File Extended Attribute (FEA) lists to NT FEA structures. This error results in an integer overflow, leading to a buffer overflow due to insufficient memory allocation.
  - **Error 2**: A discrepancy between SMB.COM.TRANSACTION2 and SMB.COM.NT.TRANSACT subcommands causes additional buffer overflow. The NTTRANSACT subcommand requires a larger data packet, and if used before TRANSACTION2, it leads to an overflow as the protocol allocates memory based only on the smaller packet.
  - **Error 3**: Exploits SMBv1's heap spraying vulnerability, allowing the allocation of memory at a specific address. This technique enables arbitrary command execution and control over the device.

![Malware_project](documents/smb_packet.PNG)

#### 4. Ransomware Encryption

**Objective**: Automate the ransomware attack to encrypt files on compromised machines and propagate throughout the corporate network.

**Method**:
- **Automation Goals**:
  - Target and encrypt as many machines as possible.
  - Encrypt files without disrupting system functionality.
  - Track encrypted files and their metadata.
  - Upload a list of encrypted files, along with data and identifiers for attacked machines, to our server.

**A. Reverse Shell Handler**:
- Automates the ransomware deployment after exploiting EternalBlue.
- Listens for a reverse shell connection on port 4321 from the first compromised machine.
- Changes directory to the target folder (e.g., `C:\Users\Public`), checks for and renames `.txt` files to `.exe` if necessary, and executes the ransomware (`ransom.exe`).
- Moves on to the next machine after execution.

**B. Main Functions of the Ransomware**:
- **get_file_metadata(file_path)**: Retrieves metadata from the file being encrypted, including name, size, last used date, extension, and path. Additional metadata is collected based on file type (e.g., image size and format).
- **generate_key(password)**: Creates a symmetric encryption key using cryptographic libraries in Python. Symmetric encryption is used for its flexibility with different passwords.
- **is_safe_toencrypt(filename)**: Ensures that files and folders being encrypted are not critical for Windows operation (e.g., excluding `Program Files`, `Windows`, and the decryption executable).
- **encrypt(filename, key)**: Encrypts the file using the Fernet module in Python and extracts metadata before encryption.
- **encrypt_folder(foldername, key)**: Recursively encrypts all files within a specified folder.
- **upload_file(file_path, upload_url)**: Uploads a file containing metadata to our server.
- **get_local_ip()**: Identifies and returns the local IP of the victim machine for naming the metadata file and organizing targets.

**C. Test Environment Description**:
- A ‘test’ folder mimicking the `C:` drive structure was created for testing. It contains various files and folders to simulate a real environment.
- Files are encrypted with visible changes in the file explorer (e.g., image previews become unavailable).
- Scripts include print statements for testing purposes; in a real attack, the ransomware operates silently without opening a command window.


#### 5. Ransomware Decryption (Optional)

**Objective**: Provide a mechanism for the victim to decrypt files upon payment of the ransom.

![Malware_project](documents/ransom_dec.PNG)

**Method**:
- **"Recover.exe"**: A GUI application designed to decrypt files encrypted during the ransomware attack.
  - **Functionality**: 
    - Decrypts files in the 'test' folder using the same encryption functions.
    - Requires a password input from the user, supporting multiple passwords for different encryption instances.
    - If a file that is not encrypted is selected, the program will handle this gracefully without breaking.
  - **Design Considerations**: 
    - Both the encryption and decryption scripts are designed to handle exceptions robustly, ensuring that the encryption process continues even if an error occurs with a particular file.


## Collaborators 
* Andreu Nadal Vargas
* Alex Romano Molar
* Oriol Miranda Garrido
