# EternalBlue Ransomware Project

This is a project, part of the Malware course of the Cybersecurity Master at UPC. For a comprehensive breakdown of each phase and the technical implementation, please refer to the accompanying PDF document at documents/Group_8-Final_Report.pdf

## Overview

The objective of this project is to compromise a small to medium-sized enterprise that operates several Windows-based systems. Initially, an email will be dispatched to an employee, informing them that their company has been chosen to test a new financial tool enhanced by machine learning and artificial intelligence. This purported tool is an Excel file embedded with a malicious macro.

Upon the employee downloading the file and enabling its content, the macro will initiate the download of additional files from our public server. Subsequently, it will conduct a scan of all machines within the same subnet as the initial target, specifically identifying those susceptible to the EternalBlue vulnerability. If vulnerable machines are detected, the macro will attempt to exploit them by deploying and executing the exploit script.


### Scenario

![Malware_project](documents/scenario.PNG)

On the left side, we observe the victim company's environment, which includes the computer designated to receive the email containing the malware, as well as other vulnerable machines within the same network. On the right side, we see the attacker's setup, comprising a Kali machine used for debugging purposes and a server responsible for the downloading and uploading of files.

### Phases of attack

This attack comprises five distinct phases (the last of which is optional) designed to infiltrate the victim's environment, perform basic reconnaissance to identify vulnerable elements, and subsequently exploit them. These phases are as follows:

- Phishing
- Environment Scanning
- EternalBlue Exploitation
- Ransomware Encryption
- Ransomware Decryption [Optional]

#### 1. Phishing

**Objective**: Gain entry into the victim's environment via a legitimate-looking entry vector.

**Method**:
- Send an email to a corporate employee, introducing a new machine learning and AI-based financial application.
- Attach an Excel file with an embedded malicious macro and a text file with instructions to enable content editing.

**Trojan Horse**:
- The Excel file contains a macro written in Visual Basic.
- Upon enabling content, the macro executes automatically.
- It collects the logged-in username and system language, downloads files from our server, executes them, and removes traces to prevent reverse engineering.


#### 2. Environment Scanning

**Objective**: Identify vulnerable machines within the local network.

**Method**:
- The macro's scan script retrieves all network interfaces (excluding the loopback interface) and uses them to search for vulnerable computers.
- The script has two main sections:
  - **Initial Check**: Determines if the computer is online by checking if port 445 (SMB) is open.
  - **Vulnerability Check**: Uses SMB to send a transaction of type `TRANS_PEEK_NMPIPE` to leak information and check if the machine is vulnerable to EternalBlue.
    - The vulnerability is identified by the Windows NT status code `0xC0000205` (STATUS_INSUFF_SERVER_RESOURCES), indicating insufficient server resources.


